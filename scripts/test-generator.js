#!/usr/bin/env node

/**
 * Test Generator - Creates a simple test schema and generates UI
 * This helps validate the generator works correctly
 */

const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

// Create a simple test schema
const testSchema = `
-- Test Schema for UI Generator
CREATE TYPE test_status AS ENUM ('active', 'inactive', 'pending');

CREATE TABLE test_users (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email text NOT NULL UNIQUE,
    first_name text NOT NULL,
    last_name text NOT NULL,
    status test_status NOT NULL DEFAULT 'active',
    bio text NULL,
    age integer NULL,
    is_verified boolean NOT NULL DEFAULT false,
    metadata jsonb DEFAULT '{}',
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE OR REPLACE FUNCTION search_test_users(
    p_filters jsonb DEFAULT '{}'
)
RETURNS TABLE (
    id bigint,
    email text,
    first_name text,
    last_name text,
    status test_status,
    created_at timestamptz
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT u.id, u.email, u.first_name, u.last_name, u.status, u.created_at
    FROM test_users u
    ORDER BY u.created_at DESC;
END;
$$;
`;

// Write test schema to temp file
const testSchemaPath = path.join(__dirname, "test-schema.sql");
fs.writeFileSync(testSchemaPath, testSchema, "utf8");
console.log("✓ Created test schema file");

// Run generator in dry-run mode
console.log("\n=== Running Generator (Dry Run) ===\n");
try {
  execSync(
    `node ${path.join(__dirname, "generate-ui-from-schema.js")} ${testSchemaPath} --dry-run`,
    {
      stdio: "inherit",
    }
  );
  console.log("\n✓ Generator ran successfully!");
} catch (error) {
  console.error("\n✗ Generator failed:", error.message);
  process.exit(1);
}

// Optional: Actually generate the files
console.log("\n=== Would you like to generate the test files? ===");
console.log("This will create:");
console.log("  - app/test-users/");
console.log("  - components/test-users/");
console.log("\nRun with --generate flag to create files:");
console.log(`  node ${path.relative(process.cwd(), __filename)} --generate`);

if (process.argv.includes("--generate")) {
  console.log("\n=== Generating Test Files ===\n");
  try {
    execSync(
      `node ${path.join(__dirname, "generate-ui-from-schema.js")} ${testSchemaPath} --force`,
      {
        stdio: "inherit",
      }
    );
    console.log("\n✓ Test files generated successfully!");
    console.log("\nTo view the generated UI:");
    console.log("  1. Start your development server: npm run dev");
    console.log("  2. Visit: http://localhost:3000/test-users");
  } catch (error) {
    console.error("\n✗ Generation failed:", error.message);
    process.exit(1);
  }
}

// Clean up
if (!process.argv.includes("--keep-schema")) {
  fs.unlinkSync(testSchemaPath);
  console.log("\n✓ Cleaned up test schema file");
}
